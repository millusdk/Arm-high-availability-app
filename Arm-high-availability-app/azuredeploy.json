{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "Arm-high-availability-app-storageType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_ZRS",
        "Standard_GRS",
        "Standard_RAGRS",
        "Premium_LRS"
      ]
    },
    "Arm-high-availability-app-adminUserName": {
      "type": "string",
      "minLength": 1
    },
    "Arm-high-availability-app-adminPassword": {
      "type": "securestring"
    },
    "Arm-high-availability-app-windowsOSVersion": {
      "type": "string",
      "defaultValue": "2016-Datacenter"
    },
    "Arm-high-availability-app-vmSize": {
      "type": "string",
      "defaultValue": "Standard_A2_v2"
    },
    "DomainName": {
      "type": "string"
    },
    "_artifactsLocation": {
      "type": "string",
      "metadata": {
        "description": "Auto-generated container in staging storage account to receive post-build staging folder upload"
      }
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "metadata": {
        "description": "Auto-generated token to access _artifactsLocation"
      }
    }
  },
  "variables": {
    "Arm-high-availability-app-baseName": "[toLower(concat('ahaa', substring(resourceGroup().name, lastIndexOf(resourceGroup().name, '-'))))]",
    "Arm-high-availability-app-vnetName": "[concat(variables('Arm-high-availability-app-baseName'),'-', 'vnet')]",
    "Arm-high-availability-app-vnetID": "[resourceId('Microsoft.Network/virtualNetworks', variables('Arm-high-availability-app-vnetName'))]",
    "Arm-high-availability-app-vnetPrefix": "10.0.0.0/16",
    "Arm-high-availability-app-vnetDmzName": "DMZ",
    "Arm-high-availability-app-vnetDmzPrefix": "10.0.0.0/24",
    "Arm-high-availability-app-vnetLanName": "LAN",
    "Arm-high-availability-app-vnetLanPrefix": "10.0.1.0/24",

    "Arm-high-availability-app-dc-availability-set-name": "[concat(variables('Arm-high-availability-app-baseName'), '-', 'dc', '-', 'availabilitySet')]",
    "Arm-high-availability-app-sql-availability-set-name": "[concat(variables('Arm-high-availability-app-baseName'), '-', 'sql', '-', 'availabilitySet')]",
    "Arm-high-availability-app-web-availability-set-name": "[concat(variables('Arm-high-availability-app-baseName'), '-', 'web', '-', 'availabilitySet')]",

    "nestedTemplatefolder": "nestedtemplates",

    "dc01TemplateFileName": "dc01.json",
    "dc02TemplateFileName": "dc02.json",
    "sqlTemplateFileName": "sql.json",
    "webTemplateFileName": "web.json",
    "Vnet DNS updateTemplateFolder": "nestedtemplates",
    "Vnet DNS updateTemplateFileName": "Vnet DNS update.json",
    "Vnet DNS updateTemplateParametersFileName": "Vnet DNS update.parameters.json"
  },
  "resources": [
    {
      "name": "[variables('Arm-high-availability-app-vnetName')]",
      "type": "Microsoft.Network/virtualNetworks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2016-03-30",
      "dependsOn": [],
      "tags": {
        "displayName": "Vnet"
      },
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('Arm-high-availability-app-vnetPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('Arm-high-availability-app-vnetDmzName')]",
            "properties": {
              "addressPrefix": "[variables('Arm-high-availability-app-vnetDmzPrefix')]"
            }
          },
          {
            "name": "[variables('Arm-high-availability-app-vnetLanName')]",
            "properties": {
              "addressPrefix": "[variables('Arm-high-availability-app-vnetLanPrefix')]"
            }
          }
        ]
      }
    },
    {
      "name": "[variables('Arm-high-availability-app-dc-availability-set-name')]",
      "type": "Microsoft.Compute/availabilitySets",
      "location": "[resourceGroup().location]",
      "apiVersion": "2015-06-15",
      "dependsOn": [],
      "tags": {
        "displayName": "Domain controller availability set"
      },
      "properties": {
        "platformUpdateDomainCount": 2,
        "platformFaultDomainCount": 2
      }
    },
    {
      "name": "[variables('Arm-high-availability-app-sql-availability-set-name')]",
      "type": "Microsoft.Compute/availabilitySets",
      "location": "[resourceGroup().location]",
      "apiVersion": "2015-06-15",
      "dependsOn": [],
      "tags": {
        "displayName": "Sql server availability set"
      },
      "properties": {
        "platformUpdateDomainCount": 3,
        "platformFaultDomainCount": 3
      }
    },
    {
      "name": "[variables('Arm-high-availability-app-web-availability-set-name')]",
      "type": "Microsoft.Compute/availabilitySets",
      "location": "[resourceGroup().location]",
      "apiVersion": "2015-06-15",
      "dependsOn": [],
      "tags": {
        "displayName": "Web server availability set"
      },
      "properties": {
        "platformUpdateDomainCount": 3,
        "platformFaultDomainCount": 3
      }
    },
    {
      "name": "dc01",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', variables('Arm-high-availability-app-vnetName'))]",
        "[resourceId('Microsoft.Compute/availabilitySets', variables('Arm-high-availability-app-dc-availability-set-name'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('nestedTemplatefolder'), '/', variables('dc01TemplateFileName'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "Arm-high-availability-app-baseName": {
            "value": "[variables('Arm-high-availability-app-baseName')]"
          },
          "Arm-high-availability-app-vnetID": {
            "value": "[variables('Arm-high-availability-app-vnetID')]"
          },
          "Arm-high-availability-app-vnetLanName": {
            "value": "[variables('Arm-high-availability-app-vnetLanName')]"
          },

          "Arm-high-availability-app-dc01storageType": {
            "value": "[parameters('Arm-high-availability-app-storageType')]"
          },
          "Arm-high-availability-app-dc01AdminUserName": {
            "value": "[parameters('Arm-high-availability-app-adminUserName')]"
          },
          "Arm-high-availability-app-dc01AdminPassword": {
            "value": "[parameters('Arm-high-availability-app-adminPassword')]"
          },
          "Arm-high-availability-app-dc01WindowsOSVersion": {
            "value": "[parameters('Arm-high-availability-app-windowsOSVersion')]"
          },
          "Arm-high-availability-app-dc-availability-set-name": {
            "value": "[variables('Arm-high-availability-app-dc-availability-set-name')]"
          },
          "Arm-high-availability-app-dc01VmSize": {
            "value": "[parameters('Arm-high-availability-app-vmSize')]"
          },
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    },
    {
      "name": "VnetDNSUpdate",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'dc01')]"
      ],
      "properties": {
        "mode": "Incremental",
        "parameters": {},
        "template": {
          "$schema": "https: //schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[variables('Arm-high-availability-app-vnetName')]",
              "type": "Microsoft.Network/virtualNetworks",
              "location": "[resourceGroup().location]",
              "apiVersion": "2016-03-30",
              "dependsOn": [],
              "tags": {
                "displayName": "Vnet"
              },
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[variables('Arm-high-availability-app-vnetPrefix')]"
                  ]
                },
                "dhcpOptions": {
                  "dnsServers": [
                    "10.0.1.4",
                    "10.0.1.5"
                  ]
                },
                "subnets": [
                  {
                    "name": "[variables('Arm-high-availability-app-vnetDmzName')]",
                    "properties": {
                      "addressPrefix": "[variables('Arm-high-availability-app-vnetDmzPrefix')]"
                    }
                  },
                  {
                    "name": "[variables('Arm-high-availability-app-vnetLanName')]",
                    "properties": {
                      "addressPrefix": "[variables('Arm-high-availability-app-vnetLanPrefix')]"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {}
        }
      }
    },
    {
      "name": "dc02",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "[resourceId('Microsoft.Network/virtualNetworks', variables('Arm-high-availability-app-vnetName'))]",
        "[resourceId('Microsoft.Resources/deployments', 'dc01')]",
        "[resourceId('Microsoft.Compute/availabilitySets', variables('Arm-high-availability-app-dc-availability-set-name'))]",
        "[resourceId('Microsoft.Resources/deployments', 'Vnet DNS update')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('nestedTemplatefolder'), '/', variables('dc02TemplateFileName'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "Arm-high-availability-app-baseName": {
            "value": "[variables('Arm-high-availability-app-baseName')]"
          },
          "Arm-high-availability-app-vnetID": {
            "value": "[variables('Arm-high-availability-app-vnetID')]"
          },
          "Arm-high-availability-app-vnetLanName": {
            "value": "[variables('Arm-high-availability-app-vnetLanName')]"
          },

          "Arm-high-availability-app-dc02storageType": {
            "value": "[parameters('Arm-high-availability-app-storageType')]"
          },
          "Arm-high-availability-app-dc02AdminUserName": {
            "value": "[parameters('Arm-high-availability-app-adminUserName')]"
          },
          "Arm-high-availability-app-dc02AdminPassword": {
            "value": "[parameters('Arm-high-availability-app-adminPassword')]"
          },
          "Arm-high-availability-app-dc02WindowsOSVersion": {
            "value": "[parameters('Arm-high-availability-app-windowsOSVersion')]"
          },
          "Arm-high-availability-app-dc-availability-set-name": {
            "value": "[variables('Arm-high-availability-app-dc-availability-set-name')]"
          },
          "Arm-high-availability-app-dc02VmSize": {
            "value": "[parameters('Arm-high-availability-app-vmSize')]"
          },
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    },
    {
      "name": "[concat('sql', padLeft(copyIndex(1), 2, '0'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'dc01')]",
        "[resourceId('Microsoft.Compute/availabilitySets', variables('Arm-high-availability-app-sql-availability-set-name'))]",
        "[resourceId('Microsoft.Resources/deployments', 'Vnet DNS update')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('nestedTemplatefolder'), '/', variables('sqlTemplateFileName'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "Arm-high-availability-app-baseName": {
            "value": "[variables('Arm-high-availability-app-baseName')]"
          },
          "Arm-high-availability-app-vnetID": {
            "value": "[variables('Arm-high-availability-app-vnetID')]"
          },
          "Arm-high-availability-app-vnetLanName": {
            "value": "[variables('Arm-high-availability-app-vnetLanName')]"
          },

          "Arm-high-availability-app-storageType": {
            "value": "[parameters('Arm-high-availability-app-storageType')]"
          },
          "Arm-high-availability-app-adminUserName": {
            "value": "[parameters('Arm-high-availability-app-adminUserName')]"
          },
          "Arm-high-availability-app-adminPassword": {
            "value": "[parameters('Arm-high-availability-app-adminPassword')]"
          },
          "Arm-high-availability-app-sqlVmSize": {
            "value": "[parameters('Arm-high-availability-app-vmSize')]"
          },
          "Arm-high-availability-app-sql-availability-set-name": {
            "value": "[variables('Arm-high-availability-app-sql-availability-set-name')]"
          },
          "Index": {
            "value": "[copyIndex(1)]"
          }
        }
      },
      "copy": {
        "name": "sqlcopy",
        "count": 2
      }
    },
    {
      "name": "[concat('web', padLeft(copyIndex(1), 2, '0'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'dc01')]",
        "[resourceId('Microsoft.Compute/availabilitySets', variables('Arm-high-availability-app-web-availability-set-name'))]",
        "[resourceId('Microsoft.Resources/deployments', 'Vnet DNS update')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('nestedTemplatefolder'), '/', variables('webTemplateFileName'), parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "Arm-high-availability-app-baseName": {
            "value": "[variables('Arm-high-availability-app-baseName')]"
          },
          "Arm-high-availability-app-vnetID": {
            "value": "[variables('Arm-high-availability-app-vnetID')]"
          },
          "Arm-high-availability-app-vnetDmzName": {
            "value": "[variables('Arm-high-availability-app-vnetDmzName')]"
          },

          "Arm-high-availability-app-storageType": {
            "value": "[parameters('Arm-high-availability-app-storageType')]"
          },
          "Arm-high-availability-app-adminUserName": {
            "value": "[parameters('Arm-high-availability-app-adminUserName')]"
          },
          "Arm-high-availability-app-adminPassword": {
            "value": "[parameters('Arm-high-availability-app-adminPassword')]"
          },
          "Arm-high-availability-app-webWindowsOSVersion": {
            "value": "[parameters('Arm-high-availability-app-windowsOSVersion')]"
          },

          "Arm-high-availability-app-webVmSize": {
            "value": "[parameters('Arm-high-availability-app-vmSize')]"
          },
          "Arm-high-availability-app-web-availability-set-name": {
            "value": "[variables('Arm-high-availability-app-web-availability-set-name')]"
          },
          "Index": {
            "value": "[copyIndex(1)]"
          },
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      },
      "copy": {
        "name": "webcopy",
        "count": 2
      }
    }
  ],
  "outputs": {
    "dc01": {
      "type": "object",
      "value": {
        "baseName": "[variables('Arm-high-availability-app-baseName')]"
      }
    }
  }
}
